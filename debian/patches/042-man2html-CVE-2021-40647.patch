From: Robert Luberda <robert@debian.org>
Date: Wed, 31 Jan 2024 00:24:46 +0100
Subject: Fix CVE-2021-40647

Make sure manidx_need() function allocates buffer of at least
requested size instead of always resizing manidx buffer by 10000
bytes.

This fixes a crash described in
https://gist.github.com/untaman/cb58123fe89fc65e3984165db5d40933
on a file containing a 20000-character-long string
consisting of the following bytes: "\x27" * 1; '\x53'*2;
'\x42'*19984'; '\xff'*16.

Bugs-Debian: https://bugs.debian.org/1021738
---
 man2html/man2html.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/man2html/man2html.c b/man2html/man2html.c
index 9c276eb..6379a74 100644
--- a/man2html/man2html.c
+++ b/man2html/man2html.c
@@ -1618,7 +1618,7 @@ char label[5]="lbAA";
 static void
 manidx_need(int m) {
 	if (mip + m >= manidxlen) {
-		manidxlen += 10000;
+		manidxlen = ((mip + m) / 4096 + 1) * 4096;
 		manidx = xrealloc(manidx, manidxlen);
 	}
 }
